---
description: 
globs: 
alwaysApply: true
---
# ãƒœãƒ–ãã‚“å­¦ç¿’å¸³
ã“ã‚Œã¯ãƒœãƒ–ãã‚“ãŒæ–°ã—ã„ã“ã¨ã‚’æ•™ã‚ã£ãŸã¨ãã«æ›¸ãã‚‚ã®ã§ã™

## ğŸ“ å­¦ç¿’è¨˜éŒ²ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
å„ãƒˆãƒ”ãƒƒã‚¯ã¯ä»¥ä¸‹ã®å½¢å¼ã§è¨˜éŒ²ã—ã¾ã™ï¼š
- ã‚¿ã‚¤ãƒˆãƒ«ã¯ `##` ã§å§‹ã‚ã€é©åˆ‡ãªçµµæ–‡å­—ã‚’ä»˜ã‘ã¾ã™
- å­¦ã‚“ã è¦ç‚¹ã¯ç®‡æ¡æ›¸ãã§ç°¡æ½”ã«è¨˜è¼‰
- ã‚³ãƒ¼ãƒ‰ä¾‹ãŒã‚ã‚‹å ´åˆã¯ Good/Bad ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å«ã‚ã¾ã™

## ğŸ§ª ãƒ†ã‚¹ãƒˆã®æ§‹é€ åŒ–ï¼šaggregate_failuresã®é©åˆ‡ãªä½¿ã„æ–¹

### ğŸ“Œ å­¦ã‚“ã ã“ã¨ã®è¦ç‚¹
- aggregate_failuresãƒ–ãƒ­ãƒƒã‚¯ã¯æ¤œè¨¼ï¼ˆexpectï¼‰ã®ã¿ã‚’å«ã‚ã‚‹ã¹ã
- æº–å‚™ï¼ˆsetupï¼‰ã¨å®Ÿè¡Œï¼ˆexecutionï¼‰ã¯å¤–å´ã«é…ç½®ã™ã‚‹
- ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ†ã‚¹ãƒˆã®æ„å›³ã¨å®Ÿè¡Œã®æµã‚ŒãŒæ˜ç¢ºã«ãªã‚‹

### ğŸ§ª å…·ä½“ä¾‹ï¼ˆã‚³ãƒ¼ãƒ‰ãƒ»çŠ¶æ³ãªã©ï¼‰
```ruby
# âœ… Goodï¼šæº–å‚™ã¨å®Ÿè¡Œã¯å¤–å´ã€æ¤œè¨¼ã¯å†…å´
it 'ã‚²ãƒ¼ãƒ ãŒæ­£ã—ãé–‹å§‹ã•ã‚Œã‚‹ã“ã¨' do
  # æº–å‚™ã¨å®Ÿè¡Œ
  command = GameStartCommand.new
  command_handler.handle(command)

  # æ¤œè¨¼
  aggregate_failures do
    expect(logger.messages_for_level(:info)).to include(/ã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡: ã‚²ãƒ¼ãƒ é–‹å§‹/)
    expect(GameState.last.status).to eq('started')
  end
end

# âŒ Badï¼šæº–å‚™ã‚„å®Ÿè¡Œã‚‚aggregate_failuresã®ä¸­ã«å«ã‚ã¦ã„ã‚‹
it 'ã‚²ãƒ¼ãƒ ãŒæ­£ã—ãé–‹å§‹ã•ã‚Œã‚‹ã“ã¨' do
  command = GameStartCommand.new

  aggregate_failures do
    command_handler.handle(command)  # å®Ÿè¡Œã‚’ãƒ–ãƒ­ãƒƒã‚¯å†…ã«å…¥ã‚Œã¦ã—ã¾ã£ã¦ã„ã‚‹
    expect(logger.messages_for_level(:info)).to include(/ã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡: ã‚²ãƒ¼ãƒ é–‹å§‹/)
    expect(GameState.last.status).to eq('started')
  end
end

# âŒ Badï¼šæ¤œè¨¼ãŒå¤–å´ã«ã‚‚ã‚ã‚‹
it 'ã‚²ãƒ¼ãƒ ãŒæ­£ã—ãé–‹å§‹ã•ã‚Œã‚‹ã“ã¨' do
  command = GameStartCommand.new
  command_handler.handle(command)
  expect(command).to be_valid  # æ¤œè¨¼ãŒå¤–å´ã«ã‚ã‚‹

  aggregate_failures do
    expect(logger.messages_for_level(:info)).to include(/ã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡: ã‚²ãƒ¼ãƒ é–‹å§‹/)
    expect(GameState.last.status).to eq('started')
  end
end
```

## ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ€ãƒ–ãƒ«ã®ä½¿ç”¨åˆ¶é™

### å­¦ã‚“ã ã“ã¨
- ãƒ†ã‚¹ãƒˆãƒ€ãƒ–ãƒ«ï¼ˆTestã‚¯ãƒ©ã‚¹ã‚„Mockã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰ã¯ã€å­¦ç¿’ç›®çš„ã§å®Ÿè£…æ–¹æ³•ã‚’è¨˜éŒ²ã™ã‚‹å ´åˆã‚’é™¤ã„ã¦ä½œæˆã—ãªã„
- ä»–ã«æ‰‹æ®µãŒãªã„å ´åˆã«é™ã‚Šã€æœ¬ç‰©ã®ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹

### ç†ç”±
- ã‚ˆã‚Šå®Ÿéš›ã®å‹•ä½œã«è¿‘ã„ãƒ†ã‚¹ãƒˆãŒã§ãã‚‹
- å®Ÿè£…ã®å¤‰æ›´ã«å¯¾ã—ã¦ãƒ†ã‚¹ãƒˆãŒå£Šã‚Œã«ãããªã‚‹
- ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ãŒã‚ˆã‚Šä¿¡é ¼æ€§ã®é«˜ã„ã‚‚ã®ã«ãªã‚‹

### ä¾‹
```ruby
# âŒ Badï¼šå®‰æ˜“ã«ãƒ†ã‚¹ãƒˆç”¨ã®ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆãŠã‹
class TestEventListener
  def handle_event(event)
    @received_events << event
  end
end

# âœ… Goodï¼šæœ¬ç‰©ã®ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨
let(:event_listener) { LogEventListener.new }
```

### ä¾‹å¤–
- å­¦ç¿’è¨˜éŒ²ã¨ã—ã¦å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ®‹ã™å ´åˆ
- ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒæä¾›ã™ã‚‹ãƒ†ã‚¹ãƒˆãƒ€ãƒ–ãƒ«ï¼ˆRSpecã®doubleç­‰ï¼‰


RSpecã®subjectæ´»ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³
å­¦ã‚“ã ã“ã¨
subjectã¯ãƒ†ã‚¹ãƒˆå†…ã§ã€ŒActï¼ˆå®Ÿè¡Œï¼‰ã€ã®å…±é€šåŒ–ã‚„ã€ãƒ†ã‚¹ãƒˆã®å¯èª­æ€§å‘ä¸Šã«å½¹ç«‹ã¤
åå‰ã‚’ã¤ã‘ãšã«ç„¡åã®subjectã¨ã—ã¦ä½¿ã†ã®ãŒåŸºæœ¬ï¼ˆsubject { ... }ï¼‰
contextã”ã¨ã«subjectã‚’å†å®šç¾©ã™ã‚‹ã“ã¨ã§ã€ãƒ†ã‚¹ãƒˆã®Arrange-Act-AssertãŒæ˜ç¢ºã«ãªã‚‹
letã‚„beforeã¨ã®ä½¿ã„åˆ†ã‘ã‚‚æ„è­˜ã—ã€ãƒ†ã‚¹ãƒˆã®æ„å›³ãŒä¼ã‚ã‚‹æ§‹é€ ã«ã™ã‚‹
ä¾‹
Apply to lessons.mdc
end
ãƒã‚¤ãƒ³ãƒˆ
subjectã¯ã€Œãƒ†ã‚¹ãƒˆã”ã¨ã®ä¸»å½¹ï¼ˆActï¼‰ã€ã¨ã—ã¦ä½¿ã†
ä½¿ã„æ–¹ã‚’çµ±ä¸€ã™ã‚‹ã“ã¨ã§ã€ãƒ†ã‚¹ãƒˆã®æ„å›³ãŒæ˜ç¢ºã«ãªã‚Šã€å¯èª­æ€§ãƒ»ä¿å®ˆæ€§ãŒå‘ä¸Šã™ã‚‹
åå‰ä»˜ãsubjectã‚‚ä½¿ãˆã‚‹ãŒã€ç„¡åã®subjectãŒæ¨å¥¨ã•ã‚Œã‚‹

## ğŸ§ª RSpecã§subject/let/contextã‚’æ´»ç”¨ã—ãŸãƒ†ã‚¹ãƒˆè¨­è¨ˆã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

- subjectã‚’ã€Œã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œçµæœã€ãªã©å…±é€šã®æŒ¯ã‚‹èˆã„ã§çµ±ä¸€ã™ã‚‹ã“ã¨ã§ã€ãƒ†ã‚¹ãƒˆã®é‡è¤‡ã‚’æ¸›ã‚‰ã›ã‚‹
- let(:card)ãªã©ã®å¼•æ•°ã‚’contextã”ã¨ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ã“ã¨ã§ã€æ­£å¸¸ç³»ãƒ»ç•°å¸¸ç³»ã‚’åŒã˜subjectã§æŸ”è»Ÿã«ãƒ†ã‚¹ãƒˆã§ãã‚‹
- context/let/subject/itã®è²¬å‹™ãŒæ˜ç¢ºã«ãªã‚Šã€ãƒ†ã‚¹ãƒˆã®å¯èª­æ€§ãƒ»ä¿å®ˆæ€§ãŒå¤§ããå‘ä¸Šã™ã‚‹
- RSpecã‚‰ã—ã„è‡ªç„¶ãªæ§‹é€ ã«ãªã‚Šã€ãƒ†ã‚¹ãƒˆã®æ„å›³ãŒä¼ã‚ã‚Šã‚„ã™ã„

```ruby
subject { command_handler.handle(Command.new, CommandContext.build_for_exchange(card)) }

context 'æ­£å¸¸ç³»' do
  let(:card) { Card.new(current_hand.first) }
  it 'CardExchangedEventãŒç™ºè¡Œã•ã‚Œã‚‹ã“ã¨' do
    expect(subject).to be_a(CardExchangedEvent)
  end
end

context 'ç•°å¸¸ç³»ï¼ˆæ‰‹æœ­ã«å­˜åœ¨ã—ãªã„ã‚«ãƒ¼ãƒ‰ï¼‰' do
  let(:card) { Card.new('â™ A') }
  it 'InvalidCommandEventãŒç™ºè¡Œã•ã‚Œã‚‹ã“ã¨' do
    expect(subject).to be_a(InvalidCommandEvent)
  end
end
```
```

## ğŸ§ª letã®æœ€å°åŒ–ã¨ä¾å­˜é–¢ä¿‚ã®ã¾ã¨ã‚æ–¹ï¼ˆRSpecãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ï¼‰

- letã¯ã€Œæœ¬å½“ã«è¤‡æ•°ã®exampleã§ä½¿ã†ã‚‚ã®ã€ã€Œãƒ†ã‚¹ãƒˆå…¨ä½“ã§ä½•åº¦ã‚‚å‚ç…§ã™ã‚‹ã‚‚ã®ã€ã ã‘ã«é™å®šã™ã‚‹
- ä¾å­˜é–¢ä¿‚ãŒã‚ã‚‹å ´åˆã¯ã€letã®ä¸­ã§ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã¨ã—ã¦ã¾ã¨ã‚ã¦å®šç¾©ã™ã‚‹
- ä½¿ã„æ¨ã¦ã®å€¤ã‚„ä¸€æ™‚çš„ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯letã§ã¯ãªããƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã§ååˆ†
- letã®ä¹±ç”¨ã‚’é¿ã‘ã‚‹ã“ã¨ã§ã€ãƒ†ã‚¹ãƒˆã®å¯èª­æ€§ãƒ»ä¿å®ˆæ€§ãŒå‘ä¸Šã™ã‚‹

### ä¾‹

```ruby
# âœ… Good: ä¾å­˜é–¢ä¿‚ã‚’letã®ä¸­ã§ã¾ã¨ã‚ã‚‹
let(:log_event_listener) do
  logger = TestLogger.new
  LogEventListener.new(logger)
end

# âŒ Bad: ä½¿ã„æ¨ã¦ã®å€¤ã¾ã§letã§å®šç¾©ã—ã¦ã—ã¾ã†
let(:logger) { TestLogger.new }
let(:log_event_listener) { LogEventListener.new(logger) }
```

### ãƒã‚¤ãƒ³ãƒˆ

- letã®æ•°ã¯æœ€å°é™ã«
- ä¾å­˜é–¢ä¿‚ã¯letã®ä¸­ã§ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã¨ã—ã¦ã¾ã¨ã‚ã‚‹
- ãƒ†ã‚¹ãƒˆã®å¯èª­æ€§ãƒ»ä¿å®ˆæ€§ãŒé«˜ã¾ã‚‹