# テスト概要ガイドライン

## 基本方針
- テストファーストで開発を進める
- 単体テスト、統合テスト、E2Eテストをバランスよく配置
- テストカバレッジは80%以上を目指す
- 小さなステップで進める
  - 一度に大きな変更を加えない
  - 各ステップで動作確認ができる状態を維持する
- 外から内へ実装を進める
  - インターフェース層から始める
  - ユースケース層、ドメイン層の順に実装する
  - 各層で適切なテストを書く
- モックの使用を最小限に抑える
  - 原則として実際のオブジェクトを使用する
  - 外部サービスなど、どうしても必要な場合のみモックを使用
  - モックを使う場合は、そのリスクを認識して慎重に判断する

## テストの書き方の原則

### 振る舞いに焦点を当てる
- メソッドの呼び出しを検証するのではなく、振る舞いの結果を検証する
- 「何が起きたか」を検証し、「どのように起きたか」には依存しない
- 振る舞いのテストは実装の変更に強く、リファクタリングしても壊れにくい
- モックやスタブは必要な場合のみ使用し、過剰な使用は避ける

### 実装との依存関係
- テストコードは実装の定数や設定を直接参照すべき
- 理由：
  - 実装と仕様の一致を保証できる
  - 変更の影響範囲が明確
  - メンテナンスが容易
  - テストは実装が仕様を満たしているかを確認する役割
- 例外：
  - モック/スタブでの値の定義
  - テスト固有の設定値
  - 実装から独立させたい特殊なケース

## ActiveRecordモデルのテスト方針
- ActiveRecordモデルは原則としてFactoryBotを使用して生成する
- 例外的なケースを除き、テスト内での直接のインスタンス生成は避ける
- バリデーションやスコープなどのモデルの振る舞いに焦点を当てる
- データベースの状態に依存するテストは、適切にセットアップとティアダウンを行う

## ドメインオブジェクトのテスト方針
- ドメインオブジェクトはテストダブル（モック/スタブ）を活用
- 外部依存を持つ場合は適切にモック化
- 値オブジェクトは等価性のテストを重視

## ユースケースのテスト方針
- 入力と出力の検証に焦点を当てる
- 内部実装の詳細にはあまり依存しない
- 境界値や異常系のテストを充実させる

## コントローラーのテスト方針
- リクエストスペックを中心に実装
- レスポンスのステータスコードと内容を検証
- 認証・認可のテストを含める

## ビューのテスト方針
- システムスペックで重要なUI要素の表示を検証
- JavaScript動作を含む場合はCapybaraとSeleniumを活用

## CI/CD連携
- プルリクエスト時に自動的にテストを実行
- テストが失敗した場合はマージを禁止
- テストカバレッジレポートを生成して可視化

## テストデータの作成方針

### FactoryBotの使用
- 原則として`build`を使用し、必要な場合のみ`create`を使用する
  - `build`: DBに保存せずにインスタンスを作成（高速）
  - `create`: DBに保存してインスタンスを作成（低速）
- `create`を使用するケース：
  - 関連オブジェクトの取得が必要な場合
  - DBに依存する機能をテストする場合
  - バリデーションが外部キー制約に依存する場合
- パフォーマンスを意識し、不必要なDB操作を避ける
- テスト実行速度の向上のため、可能な限り`build_stubbed`も検討する 